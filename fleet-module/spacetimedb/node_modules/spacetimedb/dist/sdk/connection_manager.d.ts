/**
 * ConnectionManager - A reference-counted connection manager for SpacetimeDB.
 *
 * This module implements a TanStack Query-style pattern for managing WebSocket
 * connections in React applications. It solves the React StrictMode double-mount
 * problem by using reference counting and deferred cleanup.
 *
 * ## How it works:
 *
 * 1. **Reference Counting**: Each `retain()` increments a counter, `release()` decrements it.
 *    The connection is only closed when the count reaches zero.
 *
 * 2. **Deferred Cleanup**: When refCount hits zero, cleanup is scheduled via `setTimeout(0)`.
 *    This allows React StrictMode's rapid unmount→remount cycle to cancel the cleanup.
 *
 * 3. **useSyncExternalStore Integration**: The `subscribe()` and `getSnapshot()` methods
 *    are designed to work with React's `useSyncExternalStore` hook for tear-free reads.
 *
 * ## StrictMode Lifecycle:
 *
 * ```
 * Mount   → retain()  → refCount: 0→1, connection created
 * Unmount → release() → refCount: 1→0, cleanup SCHEDULED (not executed)
 * Remount → retain()  → refCount: 0→1, cleanup CANCELLED
 * Result: Single WebSocket survives ✓
 * ```
 *
 * @module connection_manager
 */
import type { DbConnectionBuilder, DbConnectionImpl } from './db_connection_impl';
import type { Identity } from '../lib/identity';
import { ConnectionId } from '../lib/connection_id';
/** Represents the current state of a managed connection. */
export type ConnectionState = {
    isActive: boolean;
    identity?: Identity;
    token?: string;
    connectionId: ConnectionId;
    connectionError?: Error;
};
type Listener = () => void;
/**
 * Singleton manager for SpacetimeDB connections.
 * Use the exported `ConnectionManager` instance rather than instantiating directly.
 */
declare class ConnectionManagerImpl {
    #private;
    /** Generates a unique key for a connection based on URI and module name. */
    static getKey(uri: string, moduleName: string): string;
    /** Instance method wrapper for getKey. */
    getKey(uri: string, moduleName: string): string;
    /**
     * Retains a connection, incrementing its reference count.
     * Creates the connection on first call; returns existing connection on subsequent calls.
     * Cancels any pending release if the connection was about to be cleaned up.
     *
     * @param key - Unique identifier for the connection (use getKey to generate)
     * @param builder - Connection builder to create the connection if needed
     * @returns The managed connection instance
     */
    retain<T extends DbConnectionImpl<any>>(key: string, builder: DbConnectionBuilder<T>): T;
    release(key: string): void;
    subscribe(key: string, listener: Listener): () => void;
    getSnapshot(key: string): ConnectionState | undefined;
    getConnection<T extends DbConnectionImpl<any>>(key: string): T | null;
}
export declare const ConnectionManager: ConnectionManagerImpl;
export {};
//# sourceMappingURL=connection_manager.d.ts.map