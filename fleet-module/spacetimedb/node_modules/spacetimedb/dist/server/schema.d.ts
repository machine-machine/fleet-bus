import { moduleHooks, type ModuleDefaultExport } from 'spacetime:sys@2.0';
import { CaseConversionPolicy } from '../lib/autogen/types';
import { type ParamsObj, type Reducer } from '../lib/reducers';
import { ModuleContext, type TablesToSchema, type UntypedSchemaDef } from '../lib/schema';
import type { UntypedTableSchema } from '../lib/table_schema';
import { TypeBuilder } from '../lib/type_builders';
import { type ProcedureExport, type ProcedureFn, type ProcedureOpts, type Procedures } from './procedures';
import { type ReducerExport, type ReducerOpts, type Reducers } from './reducers';
import { type AnonViews, type AnonymousViewFn, type ViewExport, type ViewFn, type ViewOpts, type ViewReturnTypeBuilder, type Views } from './views';
export declare class SchemaInner<S extends UntypedSchemaDef = UntypedSchemaDef> extends ModuleContext {
    schemaType: S;
    existingFunctions: Set<string>;
    reducers: Reducers;
    procedures: Procedures;
    views: Views;
    anonViews: AnonViews;
    /**
     * Maps ReducerExport objects to the name of the reducer.
     * Used for resolving the reducers of scheduled tables.
     */
    functionExports: Map<ReducerExport<UntypedSchemaDef, any> | ProcedureExport<UntypedSchemaDef, any, any>, string>;
    pendingSchedules: PendingSchedule[];
    constructor(getSchemaType: (ctx: SchemaInner<S>) => S);
    defineFunction(name: string): void;
    resolveSchedules(): void;
}
type PendingSchedule = UntypedTableSchema['schedule'] & {
    tableName: string;
};
/**
 * The Schema class represents the database schema for a SpacetimeDB application.
 * It encapsulates the table definitions and typespace, and provides methods to define
 * reducers and lifecycle hooks.
 *
 * Schema has a generic parameter S which represents the inferred schema type. This type
 * is automatically inferred when creating a schema using the `schema()` function and is
 * used to type the database view in reducer contexts.
 *
 * The methods on this class are used to register reducers and lifecycle hooks
 * with the SpacetimeDB runtime. Theey forward to free functions that handle the actual
 * registration logic, but having them as methods on the Schema class helps with type inference.
 *
 * @template S - The inferred schema type of the SpacetimeDB module.
 *
 * @example
 * ```typescript
 * const spacetimedb = schema({
 *   user: table({}, userType),
 *   post: table({}, postType)
 * });
 * spacetimedb.reducer(
 *   'create_user',
 *   {  username: t.string(), email: t.string() },
 *   (ctx, { username, email }) => {
 *     ctx.db.user.insert({ username, email, created_at: ctx.timestamp });
 *     console.log(`User ${username} created by ${ctx.sender.identityId}`);
 *   }
 * );
 * ```
 */
export declare class Schema<S extends UntypedSchemaDef> implements ModuleDefaultExport {
    #private;
    constructor(ctx: SchemaInner<S>);
    [moduleHooks](exports: object): import("spacetime:sys@2.0").ModuleHooks;
    get schemaType(): S;
    get moduleDef(): import("../lib/schema").ModuleDef;
    get typespace(): {
        readonly types: ({
            tag: "Ref";
            value: number;
        } | {
            tag: "Sum";
            value: import("..").SumTypeType;
        } | {
            tag: "Product";
            value: import("..").ProductTypeType;
        } | {
            tag: "Array";
            value: import(".").AlgebraicTypeType;
        } | {
            tag: "String";
        } | {
            tag: "Bool";
        } | {
            tag: "I8";
        } | {
            tag: "U8";
        } | {
            tag: "I16";
        } | {
            tag: "U16";
        } | {
            tag: "I32";
        } | {
            tag: "U32";
        } | {
            tag: "I64";
        } | {
            tag: "U64";
        } | {
            tag: "I128";
        } | {
            tag: "U128";
        } | {
            tag: "I256";
        } | {
            tag: "U256";
        } | {
            tag: "F32";
        } | {
            tag: "F64";
        })[];
    };
    /**
     * Defines a SpacetimeDB reducer function.
     *
     * Reducers are the primary way to modify the state of your SpacetimeDB application.
     * They are atomic, meaning that either all operations within a reducer succeed,
     * or none of them do.
     *
     * @template S - The inferred schema type of the SpacetimeDB module.
     * @template Params - The type of the parameters object expected by the reducer.
     *
     * @param {Params} params - An object defining the parameters that the reducer accepts.
     *                          Each key-value pair represents a parameter name and its corresponding
     *                          {@link TypeBuilder} or {@link ColumnBuilder}.
     * @param {(ctx: ReducerCtx<S>, payload: ParamsAsObject<Params>) => void} fn - The reducer function itself.
     *   - `ctx`: The reducer context, providing access to `sender`, `timestamp`, `connection_id`, and `db`.
     *   - `payload`: An object containing the arguments passed to the reducer, typed according to `params`.
     *
     * @example
     * ```typescript
     * // Define a reducer named 'create_user' that takes 'username' (string) and 'email' (string)
     * export const create_user = spacetime.reducer(
     *   {
     *     username: t.string(),
     *     email: t.string(),
     *   },
     *   (ctx, { username, email }) => {
     *     // Access the 'user' table from the database view in the context
     *     ctx.db.user.insert({ username, email, created_at: ctx.timestamp });
     *     console.log(`User ${username} created by ${ctx.sender.identityId}`);
     *   }
     * );
     * ```
     */
    reducer<Params extends ParamsObj>(params: Params, fn: Reducer<S, Params>): ReducerExport<S, Params>;
    reducer(fn: Reducer<S, {}>): ReducerExport<S, {}>;
    reducer<Params extends ParamsObj>(opts: ReducerOpts, params: Params, fn: Reducer<S, Params>): ReducerExport<S, Params>;
    reducer(opts: ReducerOpts, fn: Reducer<S, {}>): ReducerExport<S, {}>;
    /**
     * Registers an initialization reducer that runs when the SpacetimeDB module is published
     * for the first time.
     *
     * This function is useful to set up any initial state of your database that is guaranteed
     * to run only once, and before any other reducers or client connections.
     *
     * @template S - The inferred schema type of the SpacetimeDB module.
     * @param {Reducer<S, {}>} fn - The initialization reducer function.
     *  - `ctx`: The reducer context, providing access to `sender`, `timestamp`, `connection_id`, and `db`.
     * @example
     * ```typescript
     * export const init = spacetime.init((ctx) => {
     *   ctx.db.user.insert({ username: 'admin', email: 'admin@example.com' });
     * });
     * ```
     */
    init(fn: Reducer<S, {}>): ReducerExport<S, {}>;
    init(opts: ReducerOpts, fn: Reducer<S, {}>): ReducerExport<S, {}>;
    /**
     * Registers a reducer to be called when a client connects to the SpacetimeDB module.
     * This function allows you to define custom logic that should execute
     * whenever a new client establishes a connection.
     * @template S - The inferred schema type of the SpacetimeDB module.
     *
     * @param fn - The reducer function to execute on client connection.
     *
     * @example
     * ```typescript
     * export const onConnect = spacetime.clientConnected(
     *   (ctx) => {
     *     console.log(`Client ${ctx.connectionId} connected`);
     *   }
     * );
     */
    clientConnected(fn: Reducer<S, {}>): ReducerExport<S, {}>;
    clientConnected(opts: ReducerOpts, fn: Reducer<S, {}>): ReducerExport<S, {}>;
    /**
     * Registers a reducer to be called when a client disconnects from the SpacetimeDB module.
     * This function allows you to define custom logic that should execute
     * whenever a client disconnects.
     * @template S - The inferred schema type of the SpacetimeDB module.
     *
     * @param fn - The reducer function to execute on client disconnection.
     *
     * @example
     * ```typescript
     * export const onDisconnect = spacetime.clientDisconnected(
     *   (ctx) => {
     *     console.log(`Client ${ctx.connectionId} disconnected`);
     *   }
     * );
     * ```
     */
    clientDisconnected(fn: Reducer<S, {}>): ReducerExport<S, {}>;
    clientDisconnected(opts: ReducerOpts, fn: Reducer<S, {}>): ReducerExport<S, {}>;
    view<Ret extends ViewReturnTypeBuilder, F extends ViewFn<S, {}, Ret>>(opts: ViewOpts, ret: Ret, fn: F): ViewExport<F>;
    anonymousView<Ret extends ViewReturnTypeBuilder, F extends AnonymousViewFn<S, {}, Ret>>(opts: ViewOpts, ret: Ret, fn: F): ViewExport<F>;
    procedure<Params extends ParamsObj, Ret extends TypeBuilder<any, any>>(params: Params, ret: Ret, fn: ProcedureFn<S, Params, Ret>): ProcedureFn<S, Params, Ret>;
    procedure<Ret extends TypeBuilder<any, any>>(ret: Ret, fn: ProcedureFn<S, {}, Ret>): ProcedureFn<S, {}, Ret>;
    procedure<Params extends ParamsObj, Ret extends TypeBuilder<any, any>>(opts: ProcedureOpts, params: Params, ret: Ret, fn: ProcedureFn<S, Params, Ret>): ProcedureFn<S, Params, Ret>;
    procedure<Ret extends TypeBuilder<any, any>>(opts: ProcedureOpts, ret: Ret, fn: ProcedureFn<S, {}, Ret>): ProcedureFn<S, {}, Ret>;
    /**
     * Bundle multiple reducers, procedures, etc into one value to export.
     * The name they will be exported with is their corresponding key in the `exports` argument.
     */
    exportGroup(exports: Record<string, ModuleExport>): ModuleExport;
    clientVisibilityFilter: {
        sql: (filter: string) => ModuleExport;
    };
}
export declare const registerExport: unique symbol;
export declare const exportContext: unique symbol;
export interface ModuleExport {
    [registerExport](ctx: SchemaInner, exportName: string): void;
    [exportContext]?: SchemaInner;
}
/**
 * Extracts the inferred schema type from a Schema instance
 */
export type InferSchema<SchemaDef extends Schema<any>> = SchemaDef extends Schema<infer S> ? S : never;
/**
 * Creates a schema from table definitions
 * @param handles - Array of table handles created by table() function
 * @returns ColumnBuilder representing the complete database schema
 * @example
 * ```ts
 * const spacetimedb = schema({
 *   user: table({}, userType),
 *   post: table({}, postType)
 * });
 * ```
 */
/**
 * Module-level settings that can be passed to `schema()`.
 */
export interface ModuleSettings {
    /**
     * The case conversion policy for this module.
     * Defaults to `SnakeCase` if not specified.
     *
     * @example
     * ```ts
     * export default schema({
     *   player,
     * }, { CASE_CONVERSION_POLICY: CaseConversionPolicy.None });
     * ```
     */
    CASE_CONVERSION_POLICY?: CaseConversionPolicy;
}
export declare function schema<const H extends Record<string, UntypedTableSchema>>(tables: H, moduleSettings?: ModuleSettings): Schema<TablesToSchema<H>>;
export {};
//# sourceMappingURL=schema.d.ts.map