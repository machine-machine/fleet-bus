import{fromByteArray as e}from"base64-js";import*as t from"react";import{createContext as r,useContext as n,useState as i,useRef as s,useCallback as o,useEffect as a,useSyncExternalStore as c}from"react";var f=class e{__time_duration_micros__;static MICROS_PER_MILLIS=1000n;static getAlgebraicType(){return S.Product({elements:[{name:"__time_duration_micros__",algebraicType:S.I64}]})}static isTimeDuration(e){if("Product"!==e.tag)return!1;const t=e.value.elements;if(1!==t.length)return!1;const r=t[0];return"__time_duration_micros__"===r.name&&"I64"===r.algebraicType.tag}get micros(){return this.__time_duration_micros__}get millis(){return Number(this.micros/e.MICROS_PER_MILLIS)}constructor(e){this.__time_duration_micros__=e}static fromMillis(t){return new e(BigInt(t)*e.MICROS_PER_MILLIS)}toString(){const e=this.micros,t=e<0?-e:e;return`${e<0?"-":"+"}${t/1000000n}.${String(t%1000000n).padStart(6,"0")}`}},u=class e{__timestamp_micros_since_unix_epoch__;static MICROS_PER_MILLIS=1000n;get microsSinceUnixEpoch(){return this.__timestamp_micros_since_unix_epoch__}constructor(e){this.__timestamp_micros_since_unix_epoch__=e}static getAlgebraicType(){return S.Product({elements:[{name:"__timestamp_micros_since_unix_epoch__",algebraicType:S.I64}]})}static isTimestamp(e){if("Product"!==e.tag)return!1;const t=e.value.elements;if(1!==t.length)return!1;const r=t[0];return"__timestamp_micros_since_unix_epoch__"===r.name&&"I64"===r.algebraicType.tag}static UNIX_EPOCH=new e(0n);static now(){return e.fromDate(new Date)}toMillis(){return this.microsSinceUnixEpoch/1000n}static fromDate(t){const r=t.getTime(),n=BigInt(r)*e.MICROS_PER_MILLIS;return new e(n)}toDate(){const t=this.__timestamp_micros_since_unix_epoch__/e.MICROS_PER_MILLIS;if(t>BigInt(Number.MAX_SAFE_INTEGER)||t<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range of JS's Date");return new Date(Number(t))}toISOString(){const t=this.__timestamp_micros_since_unix_epoch__,r=t/e.MICROS_PER_MILLIS;if(r>BigInt(Number.MAX_SAFE_INTEGER)||r<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range for ISO string formatting");const n=new Date(Number(r)).toISOString(),i=Math.abs(Number(t%1000000n)),s=String(i).padStart(6,"0");return n.replace(/\.\d{3}Z$/,`.${s}Z`)}since(e){return new f(this.__timestamp_micros_since_unix_epoch__-e.__timestamp_micros_since_unix_epoch__)}},l=class e{__uuid__;static NIL=new e(0n);static MAX_UUID_BIGINT=0xffffffffffffffffffffffffffffffffn;static MAX=new e(e.MAX_UUID_BIGINT);constructor(t){if(t<0n||t>e.MAX_UUID_BIGINT)throw new Error("Invalid UUID: must be between 0 and `MAX_UUID_BIGINT`");this.__uuid__=t}static fromRandomBytesV4(t){if(16!==t.length)throw new Error("UUID v4 requires 16 bytes");const r=new Uint8Array(t);return r[6]=15&r[6]|64,r[8]=63&r[8]|128,new e(e.bytesToBigInt(r))}static fromCounterV7(t,r,n){if(4!==n.length)throw new Error("`fromCounterV7` requires `randomBytes.length == 4`");if(t.value<0)throw new Error("`fromCounterV7` uuid `counter` must be non-negative");if(r.__timestamp_micros_since_unix_epoch__<0)throw new Error("`fromCounterV7` `timestamp` before unix epoch");const i=t.value;t.value=i+1&2147483647;const s=0xffffffffffffn&r.toMillis(),o=new Uint8Array(16);return o[0]=Number(s>>40n&0xffn),o[1]=Number(s>>32n&0xffn),o[2]=Number(s>>24n&0xffn),o[3]=Number(s>>16n&0xffn),o[4]=Number(s>>8n&0xffn),o[5]=Number(0xffn&s),o[7]=i>>>23&255,o[9]=i>>>15&255,o[10]=i>>>7&255,o[11]=(127&i)<<1&255,o[12]|=127&n[0],o[13]=n[1],o[14]=n[2],o[15]=n[3],o[6]=15&o[6]|112,o[8]=63&o[8]|128,new e(e.bytesToBigInt(o))}static parse(t){const r=t.replace(/-/g,"");if(32!==r.length)throw new Error("Invalid hex UUID");let n=0n;for(let e=0;e<32;e+=2)n=n<<8n|BigInt(parseInt(r.slice(e,e+2),16));return new e(n)}toString(){const t=[...e.bigIntToBytes(this.__uuid__)].map(e=>e.toString(16).padStart(2,"0")).join("");return t.slice(0,8)+"-"+t.slice(8,12)+"-"+t.slice(12,16)+"-"+t.slice(16,20)+"-"+t.slice(20)}asBigInt(){return this.__uuid__}toBytes(){return e.bigIntToBytes(this.__uuid__)}static bytesToBigInt(e){let t=0n;for(const r of e)t=t<<8n|BigInt(r);return t}static bigIntToBytes(e){const t=new Uint8Array(16);for(let r=15;r>=0;r--)t[r]=Number(0xffn&e),e>>=8n;return t}getVersion(){const t=this.toBytes()[6]>>4&15;switch(t){case 4:return"V4";case 7:return"V7";default:if(this==e.NIL)return"Nil";if(this==e.MAX)return"Max";throw new Error(`Unsupported UUID version: ${t}`)}}getCounter(){const e=this.toBytes();return e[7]<<23|e[9]<<15|e[10]<<7|e[11]>>>1}compareTo(e){return this.__uuid__<e.__uuid__?-1:this.__uuid__>e.__uuid__?1:0}static getAlgebraicType(){return S.Product({elements:[{name:"__uuid__",algebraicType:S.U128}]})}},h=class{view;offset=0;constructor(e){this.view=e instanceof DataView?e:new DataView(e.buffer,e.byteOffset,e.byteLength),this.offset=0}reset(e){this.view=e,this.offset=0}get remaining(){return this.view.byteLength-this.offset}#e(e){if(this.offset+e>this.view.byteLength)throw new RangeError(`Tried to read ${e} byte(s) at relative offset ${this.offset}, but only ${this.remaining} byte(s) remain`)}readUInt8Array(){const e=this.readU32();return this.#e(e),this.readBytes(e)}readBool(){const e=this.view.getUint8(this.offset);return this.offset+=1,0!==e}readByte(){const e=this.view.getUint8(this.offset);return this.offset+=1,e}readBytes(e){const t=new Uint8Array(this.view.buffer,this.view.byteOffset+this.offset,e);return this.offset+=e,t}readI8(){const e=this.view.getInt8(this.offset);return this.offset+=1,e}readU8(){return this.readByte()}readI16(){const e=this.view.getInt16(this.offset,!0);return this.offset+=2,e}readU16(){const e=this.view.getUint16(this.offset,!0);return this.offset+=2,e}readI32(){const e=this.view.getInt32(this.offset,!0);return this.offset+=4,e}readU32(){const e=this.view.getUint32(this.offset,!0);return this.offset+=4,e}readI64(){const e=this.view.getBigInt64(this.offset,!0);return this.offset+=8,e}readU64(){const e=this.view.getBigUint64(this.offset,!0);return this.offset+=8,e}readU128(){const e=this.view.getBigUint64(this.offset,!0),t=this.view.getBigUint64(this.offset+8,!0);return this.offset+=16,(t<<BigInt(64))+e}readI128(){const e=this.view.getBigUint64(this.offset,!0),t=this.view.getBigInt64(this.offset+8,!0);return this.offset+=16,(t<<BigInt(64))+e}readU256(){const e=this.view.getBigUint64(this.offset,!0),t=this.view.getBigUint64(this.offset+8,!0),r=this.view.getBigUint64(this.offset+16,!0),n=this.view.getBigUint64(this.offset+24,!0);return this.offset+=32,(n<<BigInt(192))+(r<<BigInt(128))+(t<<BigInt(64))+e}readI256(){const e=this.view.getBigUint64(this.offset,!0),t=this.view.getBigUint64(this.offset+8,!0),r=this.view.getBigUint64(this.offset+16,!0),n=this.view.getBigInt64(this.offset+24,!0);return this.offset+=32,(n<<BigInt(192))+(r<<BigInt(128))+(t<<BigInt(64))+e}readF32(){const e=this.view.getFloat32(this.offset,!0);return this.offset+=4,e}readF64(){const e=this.view.getFloat64(this.offset,!0);return this.offset+=8,e}readString(){const e=this.readUInt8Array();return new TextDecoder("utf-8").decode(e)}},g=ArrayBuffer.prototype.transfer??function(e){if(void 0===e)return this.slice();if(e<=this.byteLength)return this.slice(0,e);{const t=new Uint8Array(e);return t.set(new Uint8Array(this)),t.buffer}},_=class{buffer;view;constructor(e){this.buffer="number"==typeof e?new ArrayBuffer(e):e,this.view=new DataView(this.buffer)}get capacity(){return this.buffer.byteLength}grow(e){e<=this.buffer.byteLength||(this.buffer=g.call(this.buffer,e),this.view=new DataView(this.buffer))}},d=class{buffer;offset=0;constructor(e){this.buffer="number"==typeof e?new _(e):e}reset(e){this.buffer=e,this.offset=0}expandBuffer(e){const t=this.offset+e+1;if(t<=this.buffer.capacity)return;let r=2*this.buffer.capacity;r<t&&(r=t),this.buffer.grow(r)}toBase64(){return e(this.getBuffer())}getBuffer(){return new Uint8Array(this.buffer.buffer,0,this.offset)}get view(){return this.buffer.view}writeUInt8Array(e){const t=e.length;this.expandBuffer(4+t),this.writeU32(t),new Uint8Array(this.buffer.buffer,this.offset).set(e),this.offset+=t}writeBool(e){this.expandBuffer(1),this.view.setUint8(this.offset,e?1:0),this.offset+=1}writeByte(e){this.expandBuffer(1),this.view.setUint8(this.offset,e),this.offset+=1}writeI8(e){this.expandBuffer(1),this.view.setInt8(this.offset,e),this.offset+=1}writeU8(e){this.expandBuffer(1),this.view.setUint8(this.offset,e),this.offset+=1}writeI16(e){this.expandBuffer(2),this.view.setInt16(this.offset,e,!0),this.offset+=2}writeU16(e){this.expandBuffer(2),this.view.setUint16(this.offset,e,!0),this.offset+=2}writeI32(e){this.expandBuffer(4),this.view.setInt32(this.offset,e,!0),this.offset+=4}writeU32(e){this.expandBuffer(4),this.view.setUint32(this.offset,e,!0),this.offset+=4}writeI64(e){this.expandBuffer(8),this.view.setBigInt64(this.offset,e,!0),this.offset+=8}writeU64(e){this.expandBuffer(8),this.view.setBigUint64(this.offset,e,!0),this.offset+=8}writeU128(e){this.expandBuffer(16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);this.view.setBigUint64(this.offset,t,!0),this.view.setBigUint64(this.offset+8,r,!0),this.offset+=16}writeI128(e){this.expandBuffer(16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);this.view.setBigInt64(this.offset,t,!0),this.view.setBigInt64(this.offset+8,r,!0),this.offset+=16}writeU256(e){this.expandBuffer(32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,n=e>>BigInt(64)&t,i=e>>BigInt(128)&t,s=e>>BigInt(192);this.view.setBigUint64(this.offset+0,r,!0),this.view.setBigUint64(this.offset+8,n,!0),this.view.setBigUint64(this.offset+16,i,!0),this.view.setBigUint64(this.offset+24,s,!0),this.offset+=32}writeI256(e){this.expandBuffer(32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,n=e>>BigInt(64)&t,i=e>>BigInt(128)&t,s=e>>BigInt(192);this.view.setBigUint64(this.offset+0,r,!0),this.view.setBigUint64(this.offset+8,n,!0),this.view.setBigUint64(this.offset+16,i,!0),this.view.setBigInt64(this.offset+24,s,!0),this.offset+=32}writeF32(e){this.expandBuffer(4),this.view.setFloat32(this.offset,e,!0),this.offset+=4}writeF64(e){this.expandBuffer(8),this.view.setFloat64(this.offset,e,!0),this.offset+=8}writeString(e){const t=(new TextEncoder).encode(e);this.writeUInt8Array(t)}};function m(e){return Array.prototype.map.call(e.reverse(),e=>("00"+e.toString(16)).slice(-2)).join("")}function p(e){e.startsWith("0x")&&(e=e.slice(2));const t=e.match(/.{1,2}/g)||[];return Uint8Array.from(t.map(e=>parseInt(e,16))).reverse()}function w(e){return function(e){if(16!=e.length)throw new Error(`Uint8Array is not 16 bytes long: ${e}`);return new h(e).readU128()}(p(e))}function I(e){return function(e){if(32!=e.length)throw new Error(`Uint8Array is not 32 bytes long: [${e}]`);return new h(e).readU256()}(p(e))}function y(e){const t=new d(16);return t.writeU128(e),t.getBuffer()}function v(e){const t=new d(32);return t.writeU256(e),t.getBuffer()}var U=Object.hasOwn,b=class e{__identity__;constructor(e){this.__identity__="string"==typeof e?I(e):e}static getAlgebraicType(){return S.Product({elements:[{name:"__identity__",algebraicType:S.U256}]})}isEqual(e){return this.toHexString()===e.toHexString()}equals(e){return this.isEqual(e)}toHexString(){return m(v(this.__identity__))}toUint8Array(){return v(this.__identity__)}static fromString(t){return new e(t)}static zero(){return new e(0n)}toString(){return this.toHexString()}},B=new Map,F=new Map,S={Ref:e=>({tag:"Ref",value:e}),Sum:e=>({tag:"Sum",value:e}),Product:e=>({tag:"Product",value:e}),Array:e=>({tag:"Array",value:e}),String:{tag:"String"},Bool:{tag:"Bool"},I8:{tag:"I8"},U8:{tag:"U8"},I16:{tag:"I16"},U16:{tag:"U16"},I32:{tag:"I32"},U32:{tag:"U32"},I64:{tag:"I64"},U64:{tag:"U64"},I128:{tag:"I128"},U128:{tag:"U128"},I256:{tag:"I256"},U256:{tag:"U256"},F32:{tag:"F32"},F64:{tag:"F64"},makeSerializer(e,t){if("Ref"===e.tag){if(!t)throw new Error("cannot serialize refs without a typespace");for(;"Ref"===e.tag;)e=t.types[e.value]}switch(e.tag){case"Product":return O.makeSerializer(e.value,t);case"Sum":return P.makeSerializer(e.value,t);case"Array":if("U8"===e.value.tag)return A;{const r=S.makeSerializer(e.value,t);return(e,t)=>{e.writeU32(t.length);for(const n of t)r(e,n)}}default:return x[e.tag]}},serializeValue(e,t,r,n){S.makeSerializer(t,n)(e,r)},makeDeserializer(e,t){if("Ref"===e.tag){if(!t)throw new Error("cannot deserialize refs without a typespace");for(;"Ref"===e.tag;)e=t.types[e.value]}switch(e.tag){case"Product":return O.makeDeserializer(e.value,t);case"Sum":return P.makeDeserializer(e.value,t);case"Array":if("U8"===e.value.tag)return k;{const r=S.makeDeserializer(e.value,t);return e=>{const t=e.readU32(),n=Array(t);for(let i=0;i<t;i++)n[i]=r(e);return n}}default:return T[e.tag]}},deserializeValue:(e,t,r)=>S.makeDeserializer(t,r)(e),intoMapKey:function(e,t){switch(e.tag){case"U8":case"U16":case"U32":case"U64":case"U128":case"U256":case"I8":case"I16":case"I32":case"I64":case"I128":case"I256":case"F32":case"F64":case"String":case"Bool":return t;case"Product":return O.intoMapKey(e.value,t);default:{const r=new d(10);return S.serializeValue(r,e,t),r.toBase64()}}}};function E(e){return Function.prototype.call.bind(e)}var x={Bool:E(d.prototype.writeBool),I8:E(d.prototype.writeI8),U8:E(d.prototype.writeU8),I16:E(d.prototype.writeI16),U16:E(d.prototype.writeU16),I32:E(d.prototype.writeI32),U32:E(d.prototype.writeU32),I64:E(d.prototype.writeI64),U64:E(d.prototype.writeU64),I128:E(d.prototype.writeI128),U128:E(d.prototype.writeU128),I256:E(d.prototype.writeI256),U256:E(d.prototype.writeU256),F32:E(d.prototype.writeF32),F64:E(d.prototype.writeF64),String:E(d.prototype.writeString)};Object.freeze(x);var A=E(d.prototype.writeUInt8Array),T={Bool:E(h.prototype.readBool),I8:E(h.prototype.readI8),U8:E(h.prototype.readU8),I16:E(h.prototype.readI16),U16:E(h.prototype.readU16),I32:E(h.prototype.readI32),U32:E(h.prototype.readU32),I64:E(h.prototype.readI64),U64:E(h.prototype.readU64),I128:E(h.prototype.readI128),U128:E(h.prototype.readU128),I256:E(h.prototype.readI256),U256:E(h.prototype.readU256),F32:E(h.prototype.readF32),F64:E(h.prototype.readF64),String:E(h.prototype.readString)};Object.freeze(T);var k=E(h.prototype.readUInt8Array),D={Bool:1,I8:1,U8:1,I16:2,U16:2,I32:4,U32:4,I64:8,U64:8,I128:16,U128:16,I256:32,U256:32,F32:4,F64:8},z=new Set(Object.keys(D)),C=e=>e.elements.every(({algebraicType:e})=>z.has(e.tag)),$={Bool:"Uint8",I8:"Int8",U8:"Uint8",I16:"Int16",U16:"Uint16",I32:"Int32",U32:"Uint32",I64:"BigInt64",U64:"BigUint64",F32:"Float32",F64:"Float64"},M={__time_duration_micros__:e=>new f(e.readI64()),__timestamp_micros_since_unix_epoch__:e=>new u(e.readI64()),__identity__:e=>new b(e.readU256()),__connection_id__:e=>new j(e.readU128()),__uuid__:e=>new l(e.readU128())};Object.freeze(M);var N=()=>({}),R=e=>{let t;switch(e.algebraicType.tag){case"String":t="''";break;case"Bool":t="false";break;case"I8":case"U8":case"I16":case"U16":case"I32":case"U32":t="0";break;case"I64":case"U64":case"I128":case"U128":case"I256":case"U256":t="0n";break;case"F32":case"F64":t="0.0";break;default:t="undefined"}return`${e.name}: ${t}`},O={makeSerializer(e,t){let r=B.get(e);if(null!=r)return r;if(C(e)){const t=(e=>e.elements.reduce((e,{algebraicType:t})=>e+D[t.tag],0))(e),n=`"use strict";\nwriter.expandBuffer(${t});\nconst view = writer.view;\n${e.elements.map(({name:e,algebraicType:{tag:t}})=>t in $?`view.set${$[t]}(writer.offset, value.${e}, ${D[t]>1?"true":""});\nwriter.offset += ${D[t]};`:`writer.write${t}(value.${e});`).join("\n")}`;return r=Function("writer","value",n),B.set(e,r),r}const n={},i='"use strict";\n'+e.elements.map(e=>`this.${e.name}(writer, value.${e.name});`).join("\n");r=Function("writer","value",i).bind(n),B.set(e,r);for(const{name:r,algebraicType:i}of e.elements)n[r]=S.makeSerializer(i,t);return Object.freeze(n),r},serializeValue(e,t,r,n){O.makeSerializer(t,n)(e,r)},makeDeserializer(e,t){switch(e.elements.length){case 0:return N;case 1:{const t=e.elements[0].name;if(U(M,t))return M[t]}}let r=F.get(e);if(null!=r)return r;if(C(e)){const t=`"use strict";\nconst result = { ${e.elements.map(R).join(", ")} };\nconst view = reader.view;\n${e.elements.map(({name:e,algebraicType:{tag:t}})=>t in $?`result.${e} = view.get${$[t]}(reader.offset, ${D[t]>1?"true":""});\nreader.offset += ${D[t]};`:`result.${e} = reader.read${t}();`).join("\n")}\nreturn result;`;return r=Function("reader",t),F.set(e,r),r}const n={};r=Function("reader",`"use strict";\nconst result = { ${e.elements.map(R).join(", ")} };\n${e.elements.map(({name:e})=>`result.${e} = this.${e}(reader);`).join("\n")}\nreturn result;`).bind(n),F.set(e,r);for(const{name:r,algebraicType:i}of e.elements)n[r]=S.makeDeserializer(i,t);return Object.freeze(n),r},deserializeValue:(e,t,r)=>O.makeDeserializer(t,r)(e),intoMapKey(e,t){if(1===e.elements.length){const r=e.elements[0].name;if(U(M,r))return t[r]}const r=new d(10);return S.serializeValue(r,S.Product(e),t),r.toBase64()}},P={makeSerializer(e,t){if(2==e.variants.length&&"some"===e.variants[0].name&&"none"===e.variants[1].name){const r=S.makeSerializer(e.variants[0].algebraicType,t);return(e,t)=>{null!=t?(e.writeByte(0),r(e,t)):e.writeByte(1)}}if(2==e.variants.length&&"ok"===e.variants[0].name&&"err"===e.variants[1].name){const r=S.makeSerializer(e.variants[0].algebraicType,t),n=S.makeSerializer(e.variants[0].algebraicType,t);return(e,t)=>{if("ok"in t)e.writeU8(0),r(e,t.ok);else{if(!("err"in t))throw new TypeError("could not serialize result: object had neither a `ok` nor an `err` field");e.writeU8(1),n(e,t.err)}}}{let r=B.get(e);if(null!=r)return r;const n={},i=`switch (value.tag) {\n${e.variants.map(({name:e},t)=>`  case ${JSON.stringify(e)}:\n    writer.writeByte(${t});\n    return this.${e}(writer, value.value);`).join("\n")}\n  default:\n    throw new TypeError(\n      \`Could not serialize sum type; unknown tag \${value.tag}\`\n    )\n}\n`;r=Function("writer","value",i).bind(n),B.set(e,r);for(const{name:r,algebraicType:i}of e.variants)n[r]=S.makeSerializer(i,t);return Object.freeze(n),r}},serializeValue(e,t,r,n){P.makeSerializer(t,n)(e,r)},makeDeserializer(e,t){if(2==e.variants.length&&"some"===e.variants[0].name&&"none"===e.variants[1].name){const r=S.makeDeserializer(e.variants[0].algebraicType,t);return e=>{const t=e.readU8();if(0===t)return r(e);if(1!==t)throw`Can't deserialize an option type, couldn't find ${t} tag`}}if(2==e.variants.length&&"ok"===e.variants[0].name&&"err"===e.variants[1].name){const r=S.makeDeserializer(e.variants[0].algebraicType,t),n=S.makeDeserializer(e.variants[1].algebraicType,t);return e=>{const t=e.readByte();if(0===t)return{ok:r(e)};if(1===t)return{err:n(e)};throw`Can't deserialize a result type, couldn't find ${t} tag`}}{let r=F.get(e);if(null!=r)return r;const n={};r=Function("reader",`switch (reader.readU8()) {\n${e.variants.map(({name:e},t)=>`case ${t}: return { tag: ${JSON.stringify(e)}, value: this.${e}(reader) };`).join("\n")} }`).bind(n),F.set(e,r);for(const{name:r,algebraicType:i}of e.variants)n[r]=S.makeDeserializer(i,t);return Object.freeze(n),r}},deserializeValue:(e,t,r)=>P.makeDeserializer(t,r)(e)},j=class e{__connection_id__;constructor(e){this.__connection_id__=e}static getAlgebraicType(){return S.Product({elements:[{name:"__connection_id__",algebraicType:S.U128}]})}isZero(){return this.__connection_id__===BigInt(0)}static nullIfZero(e){return e.isZero()?null:e}static random(){function t(){return Math.floor(255*Math.random())}let r=BigInt(0);for(let e=0;e<16;e++)r=r<<BigInt(8)|BigInt(t());return new e(r)}isEqual(e){return this.__connection_id__==e.__connection_id__}equals(e){return this.isEqual(e)}toHexString(){return m(y(this.__connection_id__))}toUint8Array(){return y(this.__connection_id__)}static fromString(t){return new e(w(t))}static fromStringOrNull(t){const r=e.fromString(t);return r.isZero()?null:r}};function L(e,t){return V(e.data,t)}function V(e,t){switch(e.type){case"eq":return q(e.left,t)===q(e.right,t);case"ne":return q(e.left,t)!==q(e.right,t);case"gt":return q(e.left,t)>q(e.right,t);case"gte":return q(e.left,t)>=q(e.right,t);case"lt":return q(e.left,t)<q(e.right,t);case"lte":return q(e.left,t)<=q(e.right,t);case"and":return e.clauses.every(e=>V(e,t));case"or":return e.clauses.some(e=>V(e,t));case"not":return!V(e.clause,t)}}function q(e,t){return function(e){return"literal"===e.type}(e)?X(e.value):X(t[e.column])}function X(e){return function(e){return!!e&&"object"==typeof e&&"function"==typeof e.toHexString}(e)?e.toHexString():function(e){return!(!e||"object"!=typeof e)&&(e instanceof u||"bigint"==typeof e.__timestamp_micros_since_unix_epoch__)}(e)?e.__timestamp_micros_since_unix_epoch__:e}var G=r(void 0);function H(){const e=n(G);if(!e)throw new Error("useSpacetimeDB must be used within a SpacetimeDBProvider component. Did you forget to add a `SpacetimeDBProvider` to your component tree?");return e}var K=new class e{#t=new Map;static getKey(e,t){return`${e}::${t}`}getKey(t,r){return e.getKey(t,r)}#r(e){const t=this.#t.get(e);if(t)return t;const r={connection:void 0,refCount:0,state:{isActive:!1,identity:void 0,token:void 0,connectionId:j.random(),connectionError:void 0},listeners:new Set,pendingRelease:null};return this.#t.set(e,r),r}#n(e){for(const t of e.listeners)t()}retain(e,t){const r=this.#r(e);if(r.pendingRelease&&(clearTimeout(r.pendingRelease),r.pendingRelease=null),r.refCount+=1,r.connection)return r.connection;const n=t.build();r.connection=n;const i=e=>{r.state={...r.state,...e},this.#n(r)};return i({isActive:n.isActive,identity:n.identity,token:n.token,connectionId:n.connectionId,connectionError:void 0}),r.onConnect=e=>{i({isActive:e.isActive,identity:e.identity,token:e.token,connectionId:e.connectionId,connectionError:void 0})},r.onDisconnect=(e,t)=>{i({isActive:e.isActive,connectionError:t??void 0})},r.onConnectError=(e,t)=>{i({isActive:e.isActive,connectionError:t})},t.onConnect(r.onConnect),t.onDisconnect(r.onDisconnect),t.onConnectError(r.onConnectError),n}release(e){const t=this.#t.get(e);t&&(t.refCount-=1,t.refCount>0||t.pendingRelease||(t.pendingRelease=setTimeout(()=>{t.pendingRelease=null,t.refCount>0||(t.connection&&(t.onConnect&&t.connection.removeOnConnect(t.onConnect),t.onDisconnect&&t.connection.removeOnDisconnect(t.onDisconnect),t.onConnectError&&t.connection.removeOnConnectError(t.onConnectError),t.connection.disconnect()),this.#t.delete(e))},0)))}subscribe(e,t){const r=this.#r(e);return r.listeners.add(t),()=>{r.listeners.delete(t),r.refCount<=0&&0===r.listeners.size&&!r.connection&&this.#t.delete(e)}}getSnapshot(e){return this.#t.get(e)?.state}getConnection(e){return this.#t.get(e)?.connection??null}};function Z({connectionBuilder:e,children:r}){const n=e.getUri(),i=e.getModuleName(),s=t.useMemo(()=>K.getKey(n,i),[n,i]),o=t.useRef({isActive:!1,identity:void 0,token:void 0,connectionId:j.random(),connectionError:void 0}),a=t.useCallback(e=>K.subscribe(s,e),[s]),c=t.useCallback(()=>K.getSnapshot(s)??o.current,[s]),f=t.useCallback(()=>o.current,[]),u=t.useSyncExternalStore(a,c,f),l=t.useCallback(()=>K.getConnection(s),[s]),h=t.useMemo(()=>({...u,getConnection:l}),[u,l]);return t.useEffect(()=>(K.retain(s,e),()=>{K.release(s)}),[s,e]),t.createElement(G.Provider,{value:h},r)}function J(e,t){const r=function(e){if(e.table)return e.table.accessorName;if(e.accessorName)return e.accessorName;if(e.sourceQuery)return e.sourceQuery.table.accessorName;throw new Error("Cannot extract accessor name from query")}(e),n=function(e){if(e.whereClause)return e.whereClause}(e),[f,u]=i(!1);let l;try{l=H()}catch{throw new Error("Could not find SpacetimeDB client! Did you forget to add a `SpacetimeDBProvider`? `useTable` must be used in the React component tree under a `SpacetimeDBProvider` component.")}const h=e.toSql();const g=s(null),_=s(null),d=o(()=>{const e=l.getConnection();if(!e)return[[],!1];const t=e.db[r];return[n?Array.from(t.iter()).filter(e=>L(n,e)):Array.from(t.iter()),f]},[l,r,h,f]);a(()=>{const e=l.getConnection();if(l.isActive&&e){const t=e.subscriptionBuilder().onApplied(()=>{u(!0)}).subscribe(h);return()=>{t.unsubscribe()}}},[h,l.isActive,l]);const m=o(e=>{const i=(r,i)=>{n&&!L(n,i)||(t?.onInsert?.(i),r.event.id!==g.current&&(g.current=r.event.id,_.current=d(),e()))},s=(r,i)=>{n&&!L(n,i)||(t?.onDelete?.(i),r.event.id!==g.current&&(g.current=r.event.id,_.current=d(),e()))},o=(r,i,s)=>{const o=function(e,t,r){if(!e)return"stayIn";const n=L(e,t),i=L(e,r);return n&&!i?"leave":!n&&i?"enter":n&&i?"stayIn":"stayOut"}(n,i,s);switch(o){case"leave":t?.onDelete?.(i);break;case"enter":t?.onInsert?.(s);break;case"stayIn":t?.onUpdate?.(i,s);break;case"stayOut":return}r.event.id!==g.current&&(g.current=r.event.id,_.current=d(),e())},a=l.getConnection();if(!a)return()=>{};const c=a.db[r];return c.onInsert(i),c.onDelete(s),c.onUpdate?.(o),()=>{c.removeOnInsert(i),c.removeOnDelete(s),c.removeOnUpdate?.(o)}},[l,r,h,t?.onDelete,t?.onInsert,t?.onUpdate]),p=o(()=>(_.current||(_.current=d()),_.current),[d]);return c(m,p,p)}function Q(e){const{getConnection:t,isActive:r}=H(),n=e.accessorName,i=s([]);return a(()=>{const e=t();if(!e)return;const r=e.reducers[n];if(i.current.length){const e=i.current.splice(0);for(const t of e)r(...t.params).then(t.resolve,t.reject)}},[t,n,r]),o((...e)=>{const r=t();if(!r)return new Promise((t,r)=>{i.current.push({params:e,resolve:t,reject:r})});return(0,r.reducers[n])(...e)},[t,n])}export{Z as SpacetimeDBProvider,Q as useReducer,H as useSpacetimeDB,J as useTable};//# sourceMappingURL=index.mjs.map